<?php
session_start();

// --- Daftar Menu ---
$menu = [
    "Nasi Goreng" => 20000,
    "Mie Goreng" => 18000,
    "Ayam Geprek" => 22000,
    "Es Teh" => 5000,
    "Es Jeruk" => 7000,
];

// --- Proses Form ---
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $nama = $_POST['nama'];
    $nohp = $_POST['nohp'];
    $alamat = $_POST['alamat'];
    $catatan = $_POST['catatan'];
    $pesanan = $_POST['pesanan'];
    $jumlah = $_POST['jumlah'];

    $total = 0;
    $rincian = [];

    foreach ($pesanan as $index => $item) {
        if (!empty($item) && $jumlah[$index] > 0) {
            $harga = $menu[$item];
            $subtotal = $harga * $jumlah[$index];
            $total += $subtotal;
            $rincian[] = [
                'item' => $item,
                'harga' => $harga,
                'jumlah' => $jumlah[$index],
                'subtotal' => $subtotal
            ];
        }
    }

    $data_pesanan = [
        'nama' => $nama,
        'nohp' => $nohp,
        'alamat' => $alamat,
        'catatan' => $catatan,
        'rincian' => $rincian,
        'total' => $total,
        'waktu' => date("d-m-Y H:i:s")
    ];

    // Simpan ke session
    $_SESSION['riwayat'][] = $data_pesanan;

    // Tampilkan struk
    echo "<div class='struk'>
        <h2>Struk Pemesanan</h2>
        <p><strong>Nama:</strong> $nama</p>
        <p><strong>No. HP:</strong> $nohp</p>
        <p><strong>Alamat:</strong> $alamat</p>
        <p><strong>Catatan:</strong> $catatan</p>
        <table>
            <tr><th>Menu</th><th>Harga</th><th>Qty</th><th>Subtotal</th></tr>";
    foreach ($rincian as $r) {
        echo "<tr>
            <td>{$r['item']}</td>
            <td>Rp " . number_format($r['harga'], 0, ',', '.') . "</td>
            <td>{$r['jumlah']}</td>
            <td>Rp " . number_format($r['subtotal'], 0, ',', '.') . "</td>
        </tr>";
    }
    echo "<tr><td colspan='3'><strong>Total</strong></td><td><strong>Rp " . number_format($total, 0, ',', '.') . "</strong></td></tr>";
    echo "</table>
        <p><em>Waktu Pesan: {$data_pesanan['waktu']}</em></p>
        <a href='index.php' class='btn'>Pesan Lagi</a>
        <a href='?riwayat' class='btn'>Lihat Riwayat</a>
    </div>";
    exit;
}

// --- Riwayat Pesanan ---
if (isset($_GET['riwayat'])) {
    echo "<div class='riwayat'><h2>Riwayat Pesanan</h2>";
    if (!empty($_SESSION['riwayat'])) {
        foreach ($_SESSION['riwayat'] as $p) {
            echo "<div class='card'>
                <h3>{$p['nama']} ({$p['nohp']})</h3>
                <p><strong>Alamat:</strong> {$p['alamat']}</p>
                <p><strong>Catatan:</strong> {$p['catatan']}</p>
                <ul>";
            foreach ($p['rincian'] as $r) {
                echo "<li>{$r['item']} x{$r['jumlah']} - Rp " . number_format($r['subtotal'], 0, ',', '.') . "</li>";
            }
            echo "</ul>
                <p><strong>Total: Rp " . number_format($p['total'], 0, ',', '.') . "</strong></p>
                <p><em>{$p['waktu']}</em></p>
            </div>";
        }
    } else {
        echo "<p>Belum ada riwayat pesanan.</p>";
    }
    echo "<a href='index.php' class='btn'>Kembali ke Form</a></div>";
    exit;
}
?>

<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Form Pemesanan Makanan Online</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #f1f1f1;
    margin: 0;
    padding: 0;
}
.container {
    width: 450px;
    background: white;
    margin: 50px auto;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 0 10px #ccc;
}
h2 {
    text-align: center;
    margin-bottom: 20px;
}
label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
}
input, textarea, select {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    border-radius: 5px;
    border: 1px solid #ccc;
}
button, .btn {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 10px 15px;
    margin-top: 15px;
    border-radius: 5px;
    text-decoration: none;
    display: inline-block;
}
button:hover, .btn:hover {
    background-color: #218838;
}
.struk, .riwayat {
    width: 600px;
    margin: 50px auto;
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 0 10px #ccc;
}
.struk table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
.struk table, th, td {
    border: 1px solid #ddd;
}
th, td {
    padding: 8px;
    text-align: center;
}
.card {
    border: 1px solid #ddd;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
}
</style>
</head>
<body>
<div class="container">
    <h2>Form Pemesanan Makanan</h2>
    <form method="post">
        <label>Nama</label>
        <input type="text" name="nama" required>

        <label>Nomor HP</label>
        <input type="text" name="nohp" required>

        <label>Alamat</label>
        <textarea name="alamat" required></textarea>

        <label>Pesanan</label>
        <?php for ($i=0; $i<3; $i++): ?>
        <div style="display:flex; gap:10px; margin-bottom:8px;">
            <select name="pesanan[]">
                <option value="">-- Pilih Menu --</option>
                <?php foreach ($menu as $m => $h): ?>
                    <option value="<?= $m ?>"><?= $m ?> - Rp <?= number_format($h,0,',','.') ?></option>
                <?php endforeach; ?>
            </select>
            <input type="number" name="jumlah[]" min="1" placeholder="Qty" style="width:70px;">
        </div>
        <?php endfor; ?>

        <label>Catatan</label>
        <textarea name="catatan"></textarea>

        <button type="submit">Kirim Pesanan</button>
        <a href="?riwayat" class="btn" style="background:#007bff;">Lihat Riwayat</a>
    </form>
</div>
</body>
</html>
